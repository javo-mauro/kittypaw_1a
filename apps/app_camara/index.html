<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>KittyPaw - Detector de Perros y Gatos</title>
    <link rel="icon" href="data:,">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" 
          rel="stylesheet" 
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" 
          crossorigin="anonymous">

    <style>
      #resultado {
        font-weight: bold;
        font-size: 3rem;
        text-align: center;
        margin-top: 20px;
      }
      #confidence {
        font-size: 1.5rem;
        text-align: center;
        color: #666;
      }
      .preview-container {
        display: flex;
        justify-content: center;
        margin-top: 20px;
      }
      #preview {
        border: 2px solid #ddd;
        border-radius: 8px;
      }
      .camera-container {
        position: relative;
        margin: 0 auto;
        width: 400px;
        height: 400px;
      }
      #video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
      }
      #canvas {
        display: none;
      }
      .btn-camera {
        margin-top: 15px;
        width: 100%;
      }
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>

  <body>
    <main>
      <div class="px-4 py-2 my-2 text-center border-bottom">
        <h1 class="display-5 fw-bold">KittyPaw</h1>
        <div class="col-lg-6 mx-auto">
          <p class="lead mb-0">Detector de Perros y Gatos en Tiempo Real</p>
        </div>
      </div>

      <div class="container mt-5">
        <div class="row">
          <div class="col-12 col-md-6 offset-md-3 text-center">
            <div class="camera-container">
              <video id="video" playsinline autoplay></video>
              <canvas id="canvas" width="400" height="400"></canvas>
            </div>
            
            <button class="btn btn-primary btn-camera" id="cambiar-camara">Cambiar C√°mara</button>
            
            <div class="preview-container">
              <canvas id="preview" width="100" height="100"></canvas>
            </div>
            
            <div id="resultado">
              <span class="loading-spinner"></span> Cargando modelo...
            </div>
            <div id="confidence"></div>
          </div>
        </div>
      </div>

      <div class="bg-dark text-secondary mt-5 px-4 py-2 text-center">
        <div class="py-5">
          <h1 class="display-5 fw-bold text-white">Kittsandpauseen</h1>
          <div class="col-lg-6 mx-auto">
            <p class="fs-5 mb-4">Sensor <a href="https://youtube.com/RingaTech" class="text-white">Sensor</a> Sensor</p>
          </div>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" 
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" 
            crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>

    <script type="text/javascript">
      // Configuraci√≥n global
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const preview = document.getElementById("preview");
      const resultado = document.getElementById("resultado");
      const confidence = document.getElementById("confidence");
      const cambiarCamaraBtn = document.getElementById("cambiar-camara");
      
      let currentStream = null;
      let facingMode = "user";
      let modelo = null;
      let isModelLoaded = false;
      let predictionInterval = null;

      // Funci√≥n principal para cargar el modelo
      async function cargarModelo() {
        try {
          console.log("Iniciando carga del modelo...");
          
          // *********** CAMBIO CLAVE AQU√ç: Carga simplificada ***********
          // Con la √∫ltima versi√≥n de TF.js y el modelo correctamente exportado,
          // tf.loadLayersModel deber√≠a ser suficiente.
          modelo = await tf.loadGraphModel("model.json?" + new Date().getTime());
          console.log("Modelo cargado correctamente como GraphModel.");
          // *************************************************************
          
          // Verificar que el modelo se carg√≥ correctamente
          if (!modelo) {
            throw new Error("El modelo no se pudo inicializar");
          }
          
          isModelLoaded = true;
          resultado.innerHTML = "‚úÖ Acerca un perro o gato a la c√°mara";
          console.log("Modelo cargado exitosamente. Listo para predicciones.");
          
          // Iniciar la c√°mara despu√©s de cargar el modelo
          await iniciarCamara();
          
        } catch (error) {
          console.error("Error cr√≠tico al cargar el modelo:", error);
          resultado.innerHTML = `‚ùå Error: ${error.message}`;
          
          // Mostrar instrucciones de soluci√≥n adaptadas al error de InputLayer
          setTimeout(() => {
            resultado.innerHTML = `
              <div style="font-size: 1rem; color: #d32f2f;">
                <strong>Error al cargar el modelo</strong><br>
                Problema con la capa de entrada (InputLayer).<br>
                Aseg√∫rate de que el modelo fue exportado correctamente desde Python.<br>
                Verifica los archivos: model.json, group1-shard1of2.bin, group1-shard2of2.bin.
              </div>
            `;
          }, 3000);
        }
      }

      // Funci√≥n para iniciar la c√°mara
      async function iniciarCamara() {
        try {
          // Detener stream anterior si existe
          if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
          }

          const constraints = {
            audio: false,
            video: {
              facingMode: facingMode,
              width: { ideal: 400 },
              height: { ideal: 400 }
            }
          };

          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          currentStream = stream;
          video.srcObject = stream;
          
          video.onloadedmetadata = () => {
            console.log("C√°mara iniciada correctamente");
            procesarCamara();
            
            if (isModelLoaded) {
              iniciarPredicciones();
            }
          };
          
        } catch (err) {
          console.error("Error al acceder a la c√°mara:", err);
          resultado.innerHTML = "‚ùå Error al acceder a la c√°mara";
        }
      }

      // Funci√≥n para cambiar entre c√°mara frontal y trasera
      cambiarCamaraBtn.addEventListener('click', () => {
        facingMode = facingMode === "user" ? "environment" : "user";
        iniciarCamara();
      });

      // Procesamiento continuo de la c√°mara
      function procesarCamara() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        }
        requestAnimationFrame(procesarCamara);
      }

      // Funci√≥n de predicci√≥n optimizada
      async function predecir() {
        if (!modelo || !isModelLoaded || video.readyState !== video.HAVE_ENOUGH_DATA) {
          return;
        }

        try {
          // Capturar y redimensionar imagen
          const ctx = preview.getContext('2d');
          ctx.drawImage(video, 0, 0, preview.width, preview.height);
          
          const imgData = ctx.getImageData(0, 0, preview.width, preview.height);
          const data = imgData.data;
          
          // Convertir a escala de grises con optimizaci√≥n
          const input = new Float32Array(10000); // 100x100
          for (let i = 0, j = 0; i < data.length; i += 4, j++) {
            const r = data[i] / 255;
            const g = data[i + 1] / 255;
            const b = data[i + 2] / 255;
            input[j] = r * 0.299 + g * 0.587 + b * 0.114;
          }
          
          // Crear tensor con la forma correcta [1, 100, 100, 1]
          const tensor = tf.tensor4d(input, [1, 100, 100, 1]);
          
          // Realizar predicci√≥n
          const prediction = modelo.predict(tensor);
          const score = await prediction.data();
          
          // Limpiar memoria
          prediction.dispose();
          tensor.dispose();
          
          // Interpretar resultados
          const isDog = score[0] > 0.5;
          const confidenceValue = isDog ? score[0] : (1 - score[0]);
          const confidencePercentage = (confidenceValue * 100).toFixed(1);
          
          // Actualizar UI
          resultado.innerHTML = isDog ? "üê∂ Perro" : "üê± Gato";
          resultado.style.color = isDog ? "#FF6B6B" : "#4ECDC4";
          confidence.textContent = `${confidencePercentage}% de confianza`;
          
        } catch (error) {
          console.error("Error en la predicci√≥n:", error);
          // No mostrar error en UI para evitar parpadeo
        }
      }

      // Iniciar predicciones con intervalo controlado
      function iniciarPredicciones() {
        if (predictionInterval) {
          clearInterval(predictionInterval);
        }
        
        predictionInterval = setInterval(() => {
          predecir();
        }, 500);
      }

      // Limpiar recursos al cerrar la p√°gina
      window.addEventListener('beforeunload', () => {
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
        }
        if (predictionInterval) {
          clearInterval(predictionInterval);
        }
      });

      // Iniciar la aplicaci√≥n
      document.addEventListener('DOMContentLoaded', () => {
        cargarModelo();
      });
    </script>
  </body>
</html>